<div class="container">
    <div class="row">
        <div id="pedig" class="col-lg-12 col-md-12 mx-auto">

            <div id='msg' class="alert alert-dismissible fade show " style="display:none;">
                <strong>Note!</strong> This is a simple example of dismissible alert.
            </div>

            <div>

                <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);"
                    aria-label="breadcrumb">
                    <span class="navbar-text">
                        Ejemplares consultados:
                    </span>
                    <% ejem = ejemplares %>
                    <ol class="breadcrumb">
                        <% for ( let i=0; i <=ejemplares.length-1; i++){ %>
                            <li class="breadcrumb-item">
                                <a href="javascript:llamaPedigree(
                                    '<%=ejemplares[i].id%>',
                                    '<%=ejemplares[i].ownerId%>',
                                    '<%=ejemplares[i].horseName%>');">
                                    <%=ejemplares[i].horseName%>
                                </a>
                            </li>
                    
                            <% } %>
                    
                    </ol>
                </nav>
            </div>
            <div class="container text-start" id="datosCaballo">
                <div class="row ">
                    <div class="col-lg-12 ">

                        <br><br>
                        <div class="row">
                            <div>
                                <H1><strong>
                                    <%=resHorse.horseName%></strong>
                                </H1>
                                <H3><strong>Datos del ejemplar: </strong></H3>
                            </div>
                            <div class="col-sm-6 ">
                                
                                <br>
                                <br>
                                <div style="display: flex; justify-content: center"><img
                                        src="/assets/img/icono.png" onerror="this.src='/assets/img/icono.png'"
                                        width="150" height="auto" /></div>
                                <div>
                                    <br>
                                    <br>
                                    <table style=" margin: 0 auto;">
                                        <tr>
                                            <td><b>Criador:</b></td>
                                            <td><img src="<%=`https://lusitanos.s3.us-east-1.amazonaws.com/hierros/${resHorse.breeder[0]._id}.bmp`%>"
                                            onerror="this.src='/assets/img/icono.png'" width="60" height="auto" /></td>
                                            
                                            <td>                            
                                                <% if (resHorse.breeder[0].farm !=null ) { %>
                                                <%=resHorse.breeder[0].farm %>
                                                    <%} else{%>
                                                        <%=(resHorse.breeder[0].firstName + " " +
                                                            resHorse.breeder[0].lastName).trim()%>
                                                            <%}%></td>
                                        </tr>
                                        <tr >
                                            <td colspan="2"><b>No. de Criador:</b></td>
                                            <td><%=resHorse.noCriador%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>Propietario:</b></td>
                                            <td>                            
                                                <% if (resHorse.owner[0].farm !=null ) { %>
                                                <%=resHorse.owner[0].farm %>
                                                    <%} else{%>
                                                        <%=(resHorse.owner[0].firstName + " " +
                                                            resHorse.owner[0].lastName).trim()%>
                                                            <%}%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>NIN:</b></td>
                                            <td><%=resHorse.pslNum%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><strong>Sexo:</strong></td>
                                            <td>
                                                <% if (resHorse.sex==='Hembra' ) {%>
                                                    <i class="fa fa-venus" aria-hidden="true"></i>
                                                    Hembra
                                                    <%} else {%>
                                                        <i class="fa fa-mars" aria-hidden="true"></i>
                                                        Macho
                                                        <%}%>

                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>Fecha de Nacimiento:</b></td>
                                            <td><%=resHorse.foalingDate.slice(0,10)%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>Capa:</b></td>
                                            <td><%=resHorse.color%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>LG N:</b></td>
                                            <td><%=resHorse.pslSN%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>LG A:</b></td>
                                            <td><%=resHorse.otherId%></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>Puntuacion:</b></td>
                                            <td><%=(+(resHorse.valoracion[0]?.calificacion ? resHorse.valoracion[0]?.calificacion : 0 )).toFixed(2) %></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><b>Consanguineidad:</b></td>
                                            <td></td>
                                        </tr>
                                        
                                        
                                        
                                        
                                        
                                        
 


                                    </table>

                                </div>
                            </div>
                            <div class="col-sm-6 ">
                            
                                <% if ( files !=null) { %>
                                    <div id="carouselCaballos" class="carousel slide" data-bs-ride="carousel" data-bs-interval="2500">
                                        <div class="carousel-inner">
                                            <% for ( let i=0; i <=files.length-1; i++) { console.log(files[i]);  
                                                if(i===0){%>
                                                <div class="carousel-item active">
                                                    <%} else {%>
                                                        <div class="carousel-item">
                                                            <%}%>
                                                                <img class="d-block w-100 mx-auto" src="<%=`https://lusitanos.s3.us-east-1.amazonaws.com/${files[i]}`%>" id="<%= `img${i}` %>" alt="<%=`slide${i}`%>" />
                                                        </div>
                                                        <% } %>
                                                </div>
                                                <a class="carousel-control-prev" href="#carouselExampleControls" data-bs-target="#carouselCaballos"
                                                    type="button" data-bs-slide="prev">
                                                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                    <span class="sr-only">Prev</span>
                                                </a>
                                                <a class="carousel-control-next" href="#carouselExampleControls" data-bs-target="#carouselCaballos"
                                                    type="button" data-bs-slide="next">
                                                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                    <span class="sr-only">Next</span>
                                                </a>
                                        </div>
                            
                                        <%} else {  %>
                            
                                            <img class="d-block w-80 mx-auto" src="<%=`/assets/img/icono.png`%>" id="<%= `horse` %>" alt="<%=`horse`%>" />
                            
                            
                                            <%}%>
                            
                                    </div>

                            
                        </div>


                    </div>
                </div>



                <br><br>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="tab">
                            <button class="tablinks active" onclick="openForm(event, 'Genealogia')">Genealogia</button>
                            <button class="tablinks" onclick="openForm(event, 'Valoracion')">Valoración</button>
                            <button class="tablinks" onclick="openForm(event, 'Descendencia')">Descendencia de México</button>
                            <button class="tablinks" onclick="openForm(event, 'Premios')">Premios</button>
                        </div>

                    </div>
                </div>
                <div id="Premios" class="tabcontent">
                    <%= console.log('RESHORSE', resHorse) %>
                    <%- include('premios'); -%>
                    
                </div>

                <div id="Descendencia" class="tabcontent">
                    <h3>Descendencia en México</h3>
                    <div class="container">
                        <div class="row">
                            <div class="col-lg-12 col-md-12 mx-auto">
                                <br>
                                <div class="table-responsive">


                                    <table id="table3" data-search="true" data-pagination="true"
                                        data-page-list="[10, 25, 50, 100, all]" data-show-export="true"
                                        data-toolbar="#toolbar" data-id-field="_id" data-show-export="true"
                                        data-click-to-select="true">
                                        <thead>
                                            <tr class="header-color">
                                                <!-- <th data-sortable=true data-field="regNum"> No. de Registro
                                                 </th> -->
                                                <th data-sortable=true data-field="regRef"> No. Reg. Mex</th>
                                                <th data-sortable=true data-field="horseName">Nombre</th>
                                                <th data-field="sex" data-sortable=true data-formatter='sexFormatter'>
                                                    Sexo</th>
                                                <th data-sortable=true data-field="sire">Padre</th>
                                                <th data-sortable=true data-field="dam">Madre</th>
                                                <th data-sortable=true data-field="microchip">Microchip</th>
                                            </tr>

                                        </thead>

                                    </table>
                                    <script>
                                       
                                       dataHijo = <%- resHijos %>
                                            console.log(dataHijo)
                                        var $table = $('#table3')

                                        function buildTable($el)
                                        {

                                            $el.bootstrapTable({
                                                onClickRow: function (row, $element)
                                                {
                                                    llamaPedigree(row.regRef, row.ownerId, row.horseName)
                                                },
                                                data: dataHijo,

                                            })
                                            delete dataHijo
                                        }




                                        function iconformatter(value)
                                        {
                                            console.log(value)
                                            let img = `<img src="https://lusitanos.s3.us-east-1.amazonaws.com/hierros/${ value }.bmp" alt="" width="60" height="40" onerror=src="/assets/img/icono.png">'`
                                            console.log(img)
                                            return img
                                        }

                                        function dateFormatter(value)
                                        {
                                            return value.slice(0, 10)
                                        }

                                        $(function ()
                                        {
                                            buildTable($table)

                                        })
                                    </script>

                                </div>
                            </div>

                        </div>
                        <hr>
                    </div>


                </div>
                <div id="Valoracion" class="tabcontent">
                    
                    <%- include('../horses/valoraciones') %>
                </div>
                <div id="Genealogia" class="tabcontent" style="display: block ;">

                    <div>
                        <H2><strong>Genealogia </strong></H2>
                    </div>
                    <br><br>
                    <div class="chart-container" width=100%; style="border: 3px solid #8B0000">
                    </div>


                    <script id="arbolChart">
                        
                        datas = <%- arbolData %>


                        chart = new d3.OrgChart()
                            .container('.chart-container')
                            .svgWidth(1000)
                            .svgHeight(700)
                            .data(datas)
                            .nodeHeight((d) => 120)
                            .nodeWidth((d) => 320)
                            .linkUpdate(function (d, i, arr)
                            {
                                d3.select(this)
                                    .attr("stroke", "#8B0000")
                                    .attr("stroke-width", 2)

                            })
                            .siblingsMargin(node => 200)
                            .compactMarginPair(node => 100)
                            .onNodeClick(d => seleccionaNodo(d, datas))
                            .layout('left')
                            .nodeContent(function (d, i, arr, state)
                            {

                                if (d.data.sex === 'M')
                                {
                                    color = '#ffffff'
                                    sexo = `Macho`
                                } else
                                {
                                    color = '#ffffff'
                                    sexo = `Hembra`
                                }
                                if (d.data.parentId === "")
                                {
                                    d.height = 280
                                    imagenData = `<img src="/assets/img/icono.png"
                            style="position:absolute;margin-top:90px;margin-left:${ -200 }px;border-radius:75px;width:150px;height:auto;" />`
                                    nodoData1 = `
                                 <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>LG N: </strong> 
                                    <%=resHorse.pslSN%>
                                 </div>
                                 <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>LG A: </strong> 
                                    <%=resHorse.otherId%>
                                 </div>
                                 `
                                    nodoData2 = `<div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Nacimiento: </strong> 
                                    <%=resHorse.foalingDate.slice(0,10)%>
                                 </div>
                                 <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Microchip: </strong> 
                                <%=resHorse.pedigree[0].microchip%> </div>
                                <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Capa: </strong> 
                                <%=resHorse.color%> </div>
                                <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Filiación: </strong> 
                                    <%=resHorse.pv%>
                                 </div>
                                 <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Tipo de Cubrición: </strong> 
                                    <%=resHorse.tipoCubricion%>
                                 </div>
                                 <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Criador: </strong> 
                                    
                                    <% if (resHorse.breeder[0].farm !=null ) { %>
                                        <%=resHorse.breeder[0].farm %>
                                    <%} else{%>
                                        <%=(resHorse.breeder[0].firstName + " " + resHorse.breeder[0].lastName).trim()%>
                                    <%}%> </div>
                                    <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Propietario: </strong> 
                                    
                                    <% if (resHorse.owner[0].farm !=null ) { %>
                                        <%=resHorse.owner[0].farm %>
                                    <%} else{%>
                                        <%=(resHorse.owner[0].firstName + " " + resHorse.owner[0].lastName).trim()%>
                                    <%}%> </div>`

                                } else
                                {
                                    d.height = 150
                                    imagenData = ``
                                    nodoData1 = ``
                                    nodoData2 = `
                                    <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Capa: </strong> 
                                ${ d.data.color } </div>
                                    <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Microchip: </strong> 
                                    ${ d.data.microchip }
                                 </div>
                                 
                                 <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Criador: </strong> 
                                    ${ d.data.breeder }
                                    ${ d.data.farm}
                                    ${ d.data.firstName}
                                    ${ d.data.lastName}
                                 </div>`
                                }
                                return `<div
                    style="font-family: 'Inter', sans-serif;background-color:${ color }; position:absolute;text-align: left ;margin-top:-1px; margin-left:-1px;width:${ d.width }px;height:${ d.height }px;border-radius:10px;border: 3px solid #8B0000">
                    ${ imagenData }
                    <img src=" ${ `https://lusitanos.s3.us-east-1.amazonaws.com/hierros/${ d.data.breeder }.bmp` }"onerror="this.src='/assets/img/icono.png'"
                        style="position:absolute;margin-top:35px;margin-left:${ 250 }px;border-radius:100px;width:40px;height:auto;" />
                                <div style="font-size:25px;color:#ffffff;background-color:#8B0000; justify-content:center; display:flex"> <strong> ${ d.data.horseName} </strong></div>
                                
                                <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>No. Reg. Mx: </strong> ${ d.data.regRef} </div>
                                <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>NIN: </strong> 
                                    ${d.data.regNum}
                                 </div>
                                ${ nodoData1 }
                                <div style="color:#716E7B;margin-left:20px;margin-top:3px;font-size:13px;"><strong>Sexo: </strong> 
                                ${ sexo } </div>
                                ${ nodoData2 }
                                <div style="color:#716E7B; margin-left:20px; margin-top:3px;font-size:13px;"> ${ d.data.id }, ${ d.data.parentId } </div>
                </div>`



                            })

                            .render()
                        chart.setExpanded("8").render()
                        chart.setExpanded("10").render()
                        chart.setExpanded("12").render()
                        chart.setExpanded("14").render()
                        chart.fit()


                    </script>

                </div>

            </div>
        </div>
    </div>


    <script>
        function openForm(evt, form)
        {
            var i, tabcontent, tablinks
            tabcontent = document.getElementsByClassName("tabcontent")
            console.log(tabcontent)
            for (i = 0; i < tabcontent.length; i++)
            {
                tabcontent[i].style.display = "none"
            }
            tablinks = document.getElementsByClassName("tablinks")
            for (i = 0; i < tablinks.length; i++)
            {
                tablinks[i].className = tablinks[i].className.replace(" active", "")
            }
            document.getElementById(form).style.display = "block"
            evt.currentTarget.className += " active"
        }
    </script>